import { HttpHeaders } from '@angular/common/http';
import { forkJoin, of } from 'rxjs';
import { map, publishReplay, refCount, switchMap } from 'rxjs/operators';
import jsonata from 'jsonata';
/**
 * default implementation that handles choices based on schema fields.
 * can be overriden via schema.displayWith
 */
export class DefaultChoiceHandler {
    /**
     * create default choice handler
     *
     * @param http      http connection client
     */
    constructor(http) {
        this.http = http;
    }
    /**
     * load choices
     */
    load(value, schema) {
        if (!this.cache) {
            if (schema.choices) {
                // static choices are given, convert them to Choice and merge the result
                const arr = [];
                for (const s of schema.choices) {
                    arr.push(this.choice(s, schema));
                }
                this.cache = forkJoin(arr);
            }
            else {
                // load choices from URL
                this.cache = this.getChoices(schema.choicesUrl, schema.choicesUrlArgs, schema.choicesVerb).pipe(switchMap(res => {
                    if (schema.jsonata) {
                        res = jsonata(schema.jsonata).evaluate(res);
                        if (!Array.isArray(res)) {
                            res = [res];
                            // introduce jsonName, jsonValue
                        }
                    }
                    const obs = [];
                    for (const r of res) {
                        obs.push(this.choice(r, schema));
                    }
                    return forkJoin(obs);
                }), 
                // setup caching
                publishReplay(1), refCount());
            }
        }
        return this.cache;
    }
    /**
     * filter after keystroke
     */
    filter(value, schema, current, choices) {
        return choices.pipe(map(arr => {
            if (!current) {
                return arr;
            }
            const res = arr.filter(i => this.include(i, current));
            return res;
        }));
    }
    /**
     * called from filter, intended to allow subclasses to easily change filter algorithm
     */
    include(i, current) {
        var _a;
        return (_a = i.name) === null || _a === void 0 ? void 0 : _a.toLowerCase().includes(current.toLowerCase());
    }
    /**
     * default choice implementation: just reuse value as name
     * check for localName
     */
    choice(value, schema) {
        if (schema.displayWith === 'localName') {
            for (const delimiter of ['/', '#', ':', '.']) {
                const parts = value.split(delimiter);
                if (parts.length > 1) {
                    return of({ value, name: parts[parts.length - 1] });
                }
            }
            return of({ value, name: value });
        }
        if (schema.jsonata) {
            if (typeof value === 'object') {
                return of(value);
            }
            else {
                // initially, value is a simple string
                return of({ value, name: value });
            }
        }
        if (schema.displayWithChoices) {
            return of({ value, name: schema.displayWithChoices[schema.choices.indexOf(value)] });
        }
        return of({ value, name: value });
    }
    /**
     * handle GET / POST
     */
    getChoices(url, args, verb) {
        if (verb === 'GET') {
            return this.http.get(url, args);
        }
        else {
            return this.http.post(url, args, {
                headers: new HttpHeaders({
                    'Content-Type': 'application/json',
                })
            });
        }
    }
    /**
     * default: no delay
     */
    debounceTime() {
        return 0;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hvaWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvZGFzaGpvaW4vanNvbi1zY2hlbWEtZm9ybS9zcmMvbGliL2Nob2ljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFFBQVEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFaEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQU8sT0FBTyxNQUFNLFNBQVMsQ0FBQztBQTRDOUI7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLG9CQUFvQjtJQUU3Qjs7OztPQUlHO0lBQ0gsWUFBb0IsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtJQUFJLENBQUM7SUFPekM7O09BRUc7SUFDSCxJQUFJLENBQUMsS0FBVSxFQUFFLE1BQWM7UUFFM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDYixJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7Z0JBQ2hCLHdFQUF3RTtnQkFDeEUsTUFBTSxHQUFHLEdBQXlCLEVBQUUsQ0FBQztnQkFDckMsS0FBSyxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFO29CQUM1QixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7aUJBQ3BDO2dCQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQzlCO2lCQUFNO2dCQUNILHdCQUF3QjtnQkFDeEIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLGNBQWMsRUFB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RSxNQUFNLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDeEY7UUFDRCxPQUFPLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxVQUFVLENBQUMsR0FBVyxFQUFFLElBQVMsRUFBRSxJQUFZO1FBQzNDLElBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtZQUNoQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFRLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUMxQzthQUFNO1lBQ0gsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBUSxHQUFHLEVBQUUsSUFBSSxFQUFFO2dCQUNwQyxPQUFPLEVBQUUsSUFBSSxXQUFXLENBQUM7b0JBQ3JCLGNBQWMsRUFBRSxrQkFBa0I7aUJBQ3JDLENBQUM7YUFDTCxDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVk7UUFDUixPQUFPLENBQUMsQ0FBQztJQUNiLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBmb3JrSm9pbiwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgU2NoZW1hIH0gZnJvbSAnLi9zY2hlbWEnO1xyXG5pbXBvcnQgeyBtYXAsIHB1Ymxpc2hSZXBsYXksIHJlZkNvdW50LCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCBqc29uYXRhIGZyb20gJ2pzb25hdGEnO1xyXG5cclxuLyoqXHJcbiAqIGNsYXNzIGJhY2tpbmcgYSBzZWxlY3QgLyBhdXRvY29tcGxldGUgb3B0aW9uXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIENob2ljZSB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBzZWxlY3QgdmFsdWVcclxuICAgICAqL1xyXG4gICAgdmFsdWU6IGFueTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIGRpc3BsYXkgbmFtZVxyXG4gICAgICovXHJcbiAgICBuYW1lOiBzdHJpbmc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBpbnRlcmZhY2UgZm9yIGNob2ljZSBoYW5kbGVycyBmb3Igc2VsZWN0IC8gYXV0b2NvbXBsZXRlIGNob2ljZXNcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ2hvaWNlSGFuZGxlciB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBsb2FkcyB0aGUgY2hvaWNlc1xyXG4gICAgICovXHJcbiAgICBsb2FkKHZhbHVlOiBhbnksIHNjaGVtYTogU2NoZW1hKTogT2JzZXJ2YWJsZTxDaG9pY2VbXT47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiB1c2VyIHR5cGVkIGluIGF1dG9jb21wbGV0ZSBmaWVsZFxyXG4gICAgICovXHJcbiAgICBmaWx0ZXIodmFsdWU6IGFueSwgc2NoZW1hOiBTY2hlbWEsIGN1cnJlbnQ6IHN0cmluZywgY2hvaWNlczogT2JzZXJ2YWJsZTxDaG9pY2VbXT4pOiBPYnNlcnZhYmxlPENob2ljZVtdPjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIHJldHVybiBhIHNpbmdsZSBjaG9pY2UgKGkuZS4gY29udmVydCB2YWx1ZSB0byBDaG9pY2UpXHJcbiAgICAgKi9cclxuICAgIGNob2ljZSh2YWx1ZTogYW55LCBzY2hlbWE6IFNjaGVtYSk6IE9ic2VydmFibGU8Q2hvaWNlPjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIGRlbGF5IGJldHdlZW4ga2V5c3Ryb2tlcyBiZWZvcmUgbmV3IGRhdGEgaXMgbG9hZGVkXHJcbiAgICAgKi9cclxuICAgIGRlYm91bmNlVGltZSgpOiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHRoYXQgaGFuZGxlcyBjaG9pY2VzIGJhc2VkIG9uIHNjaGVtYSBmaWVsZHMuXHJcbiAqIGNhbiBiZSBvdmVycmlkZW4gdmlhIHNjaGVtYS5kaXNwbGF5V2l0aFxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIERlZmF1bHRDaG9pY2VIYW5kbGVyIGltcGxlbWVudHMgQ2hvaWNlSGFuZGxlciB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBjcmVhdGUgZGVmYXVsdCBjaG9pY2UgaGFuZGxlclxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSBodHRwICAgICAgaHR0cCBjb25uZWN0aW9uIGNsaWVudFxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogaHR0cCBjYWNoZSBmb3IgUkVTVCByZXF1ZXN0IG9uIGNvbmZpZy9UYWJsZSAoaS5lLiBzY2hlbWEgcmVxdWVzdHMpXHJcbiAgICAgKi9cclxuICAgIGNhY2hlOiBPYnNlcnZhYmxlPENob2ljZVtdPjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIGxvYWQgY2hvaWNlc1xyXG4gICAgICovXHJcbiAgICBsb2FkKHZhbHVlOiBhbnksIHNjaGVtYTogU2NoZW1hKTogT2JzZXJ2YWJsZTxDaG9pY2VbXT4ge1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY2FjaGUpIHtcclxuICAgICAgICAgICAgaWYgKHNjaGVtYS5jaG9pY2VzKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBzdGF0aWMgY2hvaWNlcyBhcmUgZ2l2ZW4sIGNvbnZlcnQgdGhlbSB0byBDaG9pY2UgYW5kIG1lcmdlIHRoZSByZXN1bHRcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFycjogT2JzZXJ2YWJsZTxDaG9pY2U+W10gPSBbXTtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcyBvZiBzY2hlbWEuY2hvaWNlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKHRoaXMuY2hvaWNlKHMsIHNjaGVtYSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5jYWNoZSA9IGZvcmtKb2luKGFycik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyBsb2FkIGNob2ljZXMgZnJvbSBVUkxcclxuICAgICAgICAgICAgICAgIHRoaXMuY2FjaGUgPSB0aGlzLmdldENob2ljZXMoc2NoZW1hLmNob2ljZXNVcmwsIHNjaGVtYS5jaG9pY2VzVXJsQXJncywgc2NoZW1hLmNob2ljZXNWZXJiKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcChyZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLmpzb25hdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9IGpzb25hdGEoc2NoZW1hLmpzb25hdGEpLmV2YWx1YXRlKHJlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9IFtyZXNdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbnRyb2R1Y2UganNvbk5hbWUsIGpzb25WYWx1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9iczogT2JzZXJ2YWJsZTxDaG9pY2U+W10gPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCByIG9mIHJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzLnB1c2godGhpcy5jaG9pY2Uociwgc2NoZW1hKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmtKb2luKG9icyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSksXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHNldHVwIGNhY2hpbmdcclxuICAgICAgICAgICAgICAgICAgICBwdWJsaXNoUmVwbGF5KDEpLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlZkNvdW50KClcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBmaWx0ZXIgYWZ0ZXIga2V5c3Ryb2tlXHJcbiAgICAgKi9cclxuICAgIGZpbHRlcih2YWx1ZTogYW55LCBzY2hlbWE6IFNjaGVtYSwgY3VycmVudDogc3RyaW5nLCBjaG9pY2VzOiBPYnNlcnZhYmxlPENob2ljZVtdPik6IE9ic2VydmFibGU8Q2hvaWNlW10+IHtcclxuICAgICAgICByZXR1cm4gY2hvaWNlcy5waXBlKG1hcChhcnIgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIWN1cnJlbnQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhcnI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcmVzID0gYXJyLmZpbHRlcihpID0+IHRoaXMuaW5jbHVkZShpLCBjdXJyZW50KSk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXM7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogY2FsbGVkIGZyb20gZmlsdGVyLCBpbnRlbmRlZCB0byBhbGxvdyBzdWJjbGFzc2VzIHRvIGVhc2lseSBjaGFuZ2UgZmlsdGVyIGFsZ29yaXRobVxyXG4gICAgICovXHJcbiAgICBpbmNsdWRlKGk6IENob2ljZSwgY3VycmVudDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGkubmFtZT8udG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhjdXJyZW50LnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogZGVmYXVsdCBjaG9pY2UgaW1wbGVtZW50YXRpb246IGp1c3QgcmV1c2UgdmFsdWUgYXMgbmFtZVxyXG4gICAgICogY2hlY2sgZm9yIGxvY2FsTmFtZVxyXG4gICAgICovXHJcbiAgICBjaG9pY2UodmFsdWU6IGFueSwgc2NoZW1hOiBTY2hlbWEpOiBPYnNlcnZhYmxlPENob2ljZT4ge1xyXG4gICAgICAgIGlmIChzY2hlbWEuZGlzcGxheVdpdGggPT09ICdsb2NhbE5hbWUnKSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgZGVsaW1pdGVyIG9mIFsnLycsICcjJywgJzonLCAnLiddKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IHZhbHVlLnNwbGl0KGRlbGltaXRlcik7XHJcbiAgICAgICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih7IHZhbHVlLCBuYW1lOiBwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXSB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gb2YoeyB2YWx1ZSwgbmFtZTogdmFsdWUgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzY2hlbWEuanNvbmF0YSkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKHZhbHVlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIGluaXRpYWxseSwgdmFsdWUgaXMgYSBzaW1wbGUgc3RyaW5nXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YoeyB2YWx1ZSwgbmFtZTogdmFsdWUgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNjaGVtYS5kaXNwbGF5V2l0aENob2ljZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKHsgdmFsdWUsIG5hbWU6IHNjaGVtYS5kaXNwbGF5V2l0aENob2ljZXNbc2NoZW1hLmNob2ljZXMuaW5kZXhPZih2YWx1ZSldIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gb2YoeyB2YWx1ZSwgbmFtZTogdmFsdWUgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBoYW5kbGUgR0VUIC8gUE9TVFxyXG4gICAgICovXHJcbiAgICBnZXRDaG9pY2VzKHVybDogc3RyaW5nLCBhcmdzOiBhbnksIHZlcmI6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgaWYgKHZlcmIgPT09ICdHRVQnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PGFueVtdPih1cmwsIGFyZ3MpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxhbnlbXT4odXJsLCBhcmdzLCB7XHJcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoe1xyXG4gICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBkZWZhdWx0OiBubyBkZWxheVxyXG4gICAgICovXHJcbiAgICBkZWJvdW5jZVRpbWUoKSB7XHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbn1cclxuIl19